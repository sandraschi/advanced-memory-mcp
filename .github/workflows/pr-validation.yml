name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+ ]]; then
            echo "âŒ PR title does not follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Examples:"
            echo "  feat: add new portmanteau tool"
            echo "  fix(content): resolve issue with note creation"
            echo "  docs: update installation guide"
            echo "Current title: $PR_TITLE"
            exit 1
          fi
          echo "âœ… PR title follows conventional commits format"

      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || "$PR_BODY" == "null" ]]; then
            echo "âŒ PR description is empty"
            echo "Please provide a detailed description of your changes"
            exit 1
          fi
          
          # Check for required sections
          if [[ ! "$PR_BODY" =~ "## ğŸ“‹ Description" ]]; then
            echo "âŒ PR description missing 'Description' section"
            exit 1
          fi
          
          if [[ ! "$PR_BODY" =~ "## ğŸ”— Related Issues" ]]; then
            echo "âŒ PR description missing 'Related Issues' section"
            exit 1
          fi
          
          echo "âœ… PR description is complete"

      - name: Check for breaking changes
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ "$PR_BODY" =~ "breaking change" || "$PR_BODY" =~ "Breaking Change" ]]; then
            echo "âš ï¸  Breaking change detected"
            if [[ ! "$PR_BODY" =~ "## ğŸ¯ Breaking Changes" ]]; then
              echo "âŒ Breaking change PR must include 'Breaking Changes' section"
              exit 1
            fi
            echo "âœ… Breaking changes section found"
          else
            echo "âœ… No breaking changes detected"
          fi

      - name: Check file changes
        run: |
          # Check for changes to critical files
          if git diff --name-only HEAD~1 | grep -E "^(src/advanced_memory/mcp/tools/|manifest\.json|server/)" > /dev/null; then
            echo "ğŸ“ Changes detected in core MCP files"
            
            # Check if tests are updated
            if ! git diff --name-only HEAD~1 | grep -E "^tests/" > /dev/null; then
              echo "âš ï¸  Warning: Core MCP changes detected but no test updates found"
              echo "Consider adding or updating tests for your changes"
            else
              echo "âœ… Test updates found"
            fi
          fi

      - name: Validate MCPB manifest
        run: |
          if [[ -f "manifest.json" ]]; then
            echo "ğŸ“‹ Validating MCPB manifest..."
            
            # Check if Node.js is available for MCPB validation
            if command -v node >/dev/null 2>&1; then
              npm install -g @anthropic-ai/mcpb
              if mcpb validate manifest.json; then
                echo "âœ… MCPB manifest is valid"
              else
                echo "âŒ MCPB manifest validation failed"
                exit 1
              fi
            else
              echo "âš ï¸  Node.js not available, skipping MCPB validation"
            fi
          fi

      - name: Check documentation updates
        run: |
          # Check if any MCP tools were modified
          if git diff --name-only HEAD~1 | grep -E "^src/advanced_memory/mcp/tools/" > /dev/null; then
            echo "ğŸ”§ MCP tools modified, checking documentation..."
            
            # Check if prompt templates were updated
            if git diff --name-only HEAD~1 | grep -E "^prompts/" > /dev/null; then
              echo "âœ… Prompt templates updated"
            else
              echo "âš ï¸  Warning: MCP tools modified but no prompt template updates found"
              echo "Consider updating the documentation for your changes"
            fi
          fi

      - name: Summary
        run: |
          echo "## ğŸ“‹ PR Validation Summary"
          echo "âœ… PR title follows conventional commits format"
          echo "âœ… PR description is complete"
          echo "âœ… File changes reviewed"
          echo "âœ… Documentation check completed"
          echo ""
          echo "ğŸ‰ PR validation passed! Ready for review."
